<!DOCTYPE html>
<html>
	<head>
		<style>
			body { text-align: center; }
			#version { font-size: 0.6em; }
			form {
				text-align: left;
				display: flex;
				flex-direction: column;
				padding: 1em 5em;
			}
			form > * { padding: 0.5em; }
			label, fieldset { margin-top: 1.5em; }
			.error {
				color: red;
				font-family: monospace;
				white-space: pre;
				text-align: left;
			}
			#save { width: 50%; }
			#output { margin-left: 6em; }
		</style>

		<script>
			$ = s => document.querySelector(s)
			const ws = new WebSocket("ws://dyalog_root/")
			const send = data => { ws.send(JSON.stringify(data)) }
			ws.onmessage = function(data) {
				// data: (error number)(message)
				result = JSON.parse(data.data)
				errorNumber = result[0]
				let p = document.createElement("p")
				p.innerHTML = result[1]
				if ( 0 !== errorNumber ) { p.classList.add("error") }
				$("#output").innerHTML=""
				$("#output").appendChild(p)
			}
			/*
			// File system SaveAs not available in HTMLRenderer,
			// for now, workaround is to save to chosen directory via backend
			function download(data, filename, type) {
				file = new Blob([data], {type: type})
				a = document.createElement("a")
				url = URL.createObjectURL(file)
				a.href = url
				a.innerHTML = "download"
				a.download = filename
				document.body.appendChild(a)
				a.click()
				setTimeout(function() {
					document.body.removeChild(a)
					window.URL.revokeObjectURL(url)
				}, 0)
			}		
			*/
			const keyMap = {
				20: "CapsLock",
				16: "Shift",
				17: "Ctrl",
				18: "Alt",
				91: "Win",
				32: "Space",
				93: "AppsKey"
			}
			suspendKeys = []
			function showKey(evt) {
				kc = evt.keyCode
				console.log(evt)
				if ( kc in keyMap && !suspendKeys.includes(keyMap[kc]) ) { suspendKeys.push(keyMap[kc]); $("#suspend_out").value = suspendKeys.join() }
			}
			function clearSuspendShortcut() { $("#suspend_out").value="" }

			function saveScript () {
				fd = new FormData($("#userOptions"))
				// TODO get suspend key option from here, unless we can make it a field form value?
				opts = objectFromForm(fd)
				$("#output").innerHTML = JSON.stringify(opts)
				send(opts)
			}

			function objectFromForm (formData) {
				// Iterate through form data and place values from elements with names like "key[subKey]" into a nested object structure
				r = {}
				fa = [...formData]
				fa.forEach(e=>{
					[fk ,v] = e;   // Form Key, Value
					if ( fk.includes("[") ){
						k = fk.slice(0,fk.indexOf("["))
						sk = fk.slice(fk.indexOf("[")+1,-1)
						if (!r[k]) { r[k] = {} }
						r[k][sk] = v
					} else {
						r[fk] = v
					}
				})
				return r
			}
			// TODO
			// en_GB fix divide!
			// Control warn about common shortcuts
			// Alt warn about menu items
			// Left Ctrl and Right Alt â‰¡ AltGr
			// Right Alt on AltGr keyboards means both Alt keys
			// Caps Lock option to disable CapsLock behaviour
		</script>
	</head>
	<body>
		<h1>APLAutoHotKey <span id="version"></span></h1>
		<p>Generate AutoHotKey scripts for APL glyph keyboard input</p>
		<form name="userOptions" id="userOptions" onkeydown="if (event.key=='Enter'){saveScript(); return false}">
			<label for="locale">Choose language: </label>
			<select name="locale">
				<option value="en_GB">English (UK)</option>     
				<option value="en_US">English (US)</option>     
				<option value="da_DK">Danish (Denmark)</option>
				<option value="fi_FI">Finnish</option>
				<option value="fr_FR">French (France)</option>          
				<option value="de_DE">German (Germnay)</option>
				<option value="it_IT">Italian (Italy)</option>
				<option value="es_ES">Spanish (Spain)</option> 
			</select>
			<fieldset>
				<legend>Choose your shifting key(s)</legend>
				<div>
					<input type="checkbox" name="shift[CapsLock]" value="CapsLock"></input>
					<label for="shift[CapsLock]">Caps Lock</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[LAlt]" value="LAlt"></input>
					<label for="shift[LAlt]">Left Alt</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[RAlt]" value="RAlt"></input>
					<label for="shift[RAlt]">Right Alt</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[LCtrl]" value="LCtrl"></input>
					<label for="shift[LCtrl]">Left Control</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[RCtrl]" value="RCtrl"></input>
					<label for="shift[RCtrl]">Right Control</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[LWin]" value="LWin"></input>
					<label for="shift[LWin]">Left Windows key</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[RWin]" value="RWin"></input>
					<label for="shift[RWin]">Right Windows key</label>
				  </div>
				  <div>
					<input type="checkbox" name="shift[AltGr]" value="AltGr"></input>
					<label for="shift[AltGr]">AltGr</label>
				  </div>
			</fieldset>
			<fieldset>
				<legend>Set a shortcut to toggle whether AutoHotKey is active (max 2 keys):</legend>
				<div>
					<input type="checkbox" name="suspend[CapsLock]" value="CapsLock"></input>
					<label for="suspend[CapsLock]">Caps Lock</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[LAlt]" value="LAlt"></input>
					<label for="suspend[LAlt]">Left Alt</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[RAlt]" value="RAlt"></input>
					<label for="suspend[RAlt]">Right Alt</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[LCtrl]" value="LCtrl"></input>
					<label for="suspend[LCtrl]">Left Control</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[RCtrl]" value="RCtrl"></input>
					<label for="suspend[RCtrl]">Right Control</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[LWin]" value="LWin"></input>
					<label for="suspend[LWin]">Left Windows key</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[RWin]" value="RWin"></input>
					<label for="suspend[RWin]">Right Windows key</label>
				  </div>
				  <div>
					<input type="checkbox" name="suspend[AltGr]" value="AltGr"></input>
					<label for="suspend[AltGr]">AltGr</label>
				  </div>
				  <p>The selected keys, when pressed together at the same time, will toggle whether AutoHotKey is active.</p>
			</fieldset>
			<label for="startup">Launch at startup:</label>
			<select name="startup">
				<option value="">None</option>
				<option value="user">This user only</option>
				<option value="all">All users (requires administrator priveleges)</option>
			</select>
			<label for="outpath">Save script to directory:</label>
			<input type="text" name="outpath" id="outpath" placeholder="C:\tmp" value="C:\tmp">
		</form>
		<button name="save" id="save" onclick="saveScript()">Generate Script</button>
		<div id="output"></div>
	</body>
</html>